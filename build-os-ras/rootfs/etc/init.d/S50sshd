#!/bin/sh
# OpenSSH server service

PIDFILE="/var/run/sshd.pid"

start() {
    # Create privilege separation directory
    mkdir -p /var/empty
    
    # Generate host keys if missing
    [ -f /etc/ssh/ssh_host_rsa_key ] || \
        ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key -N '' -q
    [ -f /etc/ssh/ssh_host_ecdsa_key ] || \
        ssh-keygen -t ecdsa -f /etc/ssh/ssh_host_ecdsa_key -N '' -q
    [ -f /etc/ssh/ssh_host_ed25519_key ] || \
        ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N '' -q
    
    # Start SSH daemon
    /usr/sbin/sshd && echo "sshd started"
}

stop() {
    # Kill daemon via PID file
    [ -f "$PIDFILE" ] && kill $(cat "$PIDFILE") 2>/dev/null && echo "sshd stopped"
    
    # Fallback: kill all sshd processes
    killall sshd 2>/dev/null
}

case "$1" in
    start) start ;;
    stop) stop ;;
    restart) stop; sleep 1; start ;;
    *) echo "Usage: $0 {start|stop|restart}"; exit 1 ;;
esac