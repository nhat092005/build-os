#!/bin/sh
# WPA supplicant service

CONF="/etc/wpa_supplicant/wpa_supplicant.conf"
PIDFILE="/var/run/wpa_supplicant.pid"

start() {
    # Validate config and interface
    [ -f "$CONF" ] || { echo "Config not found"; return 1; }
    ip link show wlan0 >/dev/null 2>&1 || { echo "wlan0 not found"; return 1; }
    
    # Start WiFi authentication in background
    ip link set wlan0 up
    wpa_supplicant -B -i wlan0 -c "$CONF" -P "$PIDFILE" && echo "wpa_supplicant started (background)"
    
    # Acquire IP in background - don't block boot
    (
        sleep 3
        udhcpc -i wlan0 -q -n >/dev/null 2>&1 && echo "IP acquired on wlan0"
    ) &
}

stop() {
    # Kill daemon and cleanup
    [ -f "$PIDFILE" ] && kill $(cat "$PIDFILE") 2>/dev/null && echo "wpa_supplicant stopped"
    rm -f "$PIDFILE"
}

case "$1" in
    start) start ;;
    stop) stop ;;
    restart) stop; sleep 1; start ;;
    *) echo "Usage: $0 {start|stop|restart}"; exit 1 ;;
esac
